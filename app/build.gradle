/*
 * AICHAT - Advanced Image Color Harmony Analysis and Transformation
 * Build configuration with Panama FFI native acceleration support
 */

plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'info.solidsoft.pitest' version '1.19.0-rc.2'
    id 'me.champeau.jmh' version '0.7.3'
}

repositories {
    mavenCentral()
}

// Java 25 toolchain
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

// JavaFX configuration
javafx {
    version = "25"
    modules = ['javafx.controls', 'javafx.fxml', 'javafx.swing']
}

dependencies {
    // Guava utilities
    implementation libs.guava
    
    // Unit Testing - JUnit 5
    testImplementation libs.junit.jupiter
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    
    // Property-Based Testing - jqwik
    testImplementation 'net.jqwik:jqwik:1.9.3'
    
    // Image comparison for visual regression testing
    testImplementation 'com.github.romankh3:image-comparison:4.4.0'
    
    // JMH for benchmarks
    jmh 'org.openjdk.jmh:jmh-core:1.37'
    jmh 'org.openjdk.jmh:jmh-generator-annprocess:1.37'
}

application {
    mainClass = 'aichat.App'
    // Enable native access for both JavaFX and Panama FFI
    applicationDefaultJvmArgs = [
        '--enable-native-access=javafx.graphics,ALL-UNNAMED',
        '-Djava.library.path=' + projectDir.absolutePath + '/src/main/resources/native/linux:' + 
                                 projectDir.parentFile.absolutePath + '/native/build'
    ]
}

// Task to build native library before running
tasks.register('buildNative', Exec) {
    workingDir "${project.rootDir}/native"
    commandLine 'make', 'all'
    
    // Don't fail if native build fails - Java fallback will be used
    ignoreExitValue = true
    
    doFirst {
        println "Building native library..."
    }
}

// Make run task depend on native build
tasks.named('run') {
    dependsOn 'buildNative'
}

tasks.named('test') {
    useJUnitPlatform()
    
    // Include jqwik property-based tests
    include '**/*Test.class'
    include '**/*Tests.class'
    include '**/*Properties.class'
    
    // Enable native access for tests
    jvmArgs '--enable-native-access=ALL-UNNAMED'
    
    // Show test output
    testLogging {
        events "passed", "skipped", "failed"
        showStandardStreams = true
        exceptionFormat = 'full'
    }
}

// Pitest mutation testing configuration
pitest {
    // Focus on well-tested core algorithmic code
    targetClasses = ['aichat.color.ColorSpaceConverter', 'aichat.model.*']
    targetTests = ['aichat.*']
    pitestVersion = '1.20.3'
    junit5PluginVersion = '1.2.1'
    threads = 4
    outputFormats = ['HTML', 'XML']
    mutationThreshold = 70
    coverageThreshold = 90
    failWhenNoMutations = false
    jvmArgs = ['--enable-native-access=ALL-UNNAMED']
    // Exclude native-dependent code paths
    excludedClasses = ['aichat.native_.*']
}

// JMH benchmarks configuration
jmh {
    iterations = 5
    warmupIterations = 3
    fork = 1
    resultFormat = 'JSON'
}
