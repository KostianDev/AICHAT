name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-java-only:
    name: Java-only Tests (No Native)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25-ea'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
    
    - name: Run tests (Java fallback mode)
      run: ./gradlew test -Dforce.java=true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-java-only
        path: app/build/reports/tests/

  test-with-native:
    name: Tests with Native Library
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25-ea'
        distribution: 'temurin'
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Build native library (without optional deps)
      working-directory: native
      run: |
        make clean || true
        make
        echo "=== Build info ==="
        make info
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
    
    - name: Run tests with native acceleration
      run: ./gradlew test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-native
        path: app/build/reports/tests/

  test-with-full-native:
    name: Tests with Full Native (TurboJPEG + OpenCL)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25-ea'
        distribution: 'temurin'
    
    - name: Install all dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libturbojpeg0-dev ocl-icd-opencl-dev
    
    - name: Build native library (full)
      working-directory: native
      run: |
        make clean || true
        make
        echo "=== Build info ==="
        make info
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
    
    - name: Run all tests
      run: ./gradlew test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-full-native
        path: app/build/reports/tests/
